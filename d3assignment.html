<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="d3/d3.min.js"></script>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<title>Hello World</title>
	</head>
	<body>
		
		<script type="text/javascript">

			/* 
			 *	DATA
			 */
			var testDataset = [5,10,15,20,25,30,30,25,20,15,10,5];
			var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

			var dataset = {};
			//dataset[i].temperature

			/* 
			 *	STATIC VALUES
			 */

			// width and height of svg
			var svgWidth = 500;
			var svgHeight = 500;

			// width of axis
			var yAxisWidth = 30;
			var xAxisHeight = 15;

			// space between bars
			var barPadding = 1;

			// space between diagram and axes
			var axisPadding = 2;

			// bar width
			var barWidth = 50;

			// bar height multiplication factor
			var heightFactor = 1;

			// width of diagram
			var diagramWidth = svgWidth - (yAxisWidth + axisPadding);
			var diagramHeight = svgHeight - xAxisHeight;

			/* 
			 *	IMPORT AND PROCESS DATA FROM METEO.CSV
			 */
		 	d3.csv("meteo.csv", function(error, data) {
		 		// If error is not null, something went wrong.
		 		if (error) {  
          			console.log(error);
		        } else {      
		        	console.log(data[0]); 
		        }

		        // change string data into ints
	 			for (var i = 0; i < data.length; i++) {
	 				data[i].day = parseInt(data[i].day);
		 			data[i].temperature = parseInt(data[i].temperature);
		 			data[i].month = parseInt(data[i].month);
		 			data[i].year = parseInt(data[i].year);
		 		}

	 			// create object with mean temperature for every month
	 			var maxTemp = 0;
	 			var meanTemp = 0;
	 			var totalTemp = 0;
	 			var noTemps = 0;
	 			
	 			// prepare nested JSON structure
	 			var year = data[0].year;
	 			var month = data[0].month;

	 			dataset[year] = {};
	 			dataset[year][month] = {};

	 			// for every line in csv file
	 			for (i = 0; i < data.length; i++) {

					totalTemp += data[i].temperature;
 					noTemps++;

 					// if first month of new year, create new year object
 					if (data[i].month === 1) {
 						year = data[i].year;
 						dataset[year] = {};
 					}

	 				// if last day of month, save object in dataset & reset counters
	 				if (data[i].day === 31 || data[i+1].month != data[i].month) {
	 					meanTemp = Math.round(totalTemp / noTemps) / 10;

	 					// record maximum temperature for yScale
	 					if (meanTemp > maxTemp) {
	 						maxTemp = meanTemp;
	 					}

	 					// set month
	 					month = data[i].month;

	 					// push month object in year object
	 					dataset[year][month] = {year: data[i-1].year, month: data[i-1].month, meanTemp: meanTemp};

	 					// reset values
	 					totalTemp = 0;
	 					noTemps = 0;
	 				}
	 			}

	 			console.log(dataset);

		 		// output data
		 		//test(dataset);		
		 	});

		 	function test(dataset) {
		 		/* 
				 *	DRAW SVG CONTAINER
				 */
				var svgContainer = d3.select("body")
					.append("svg")
					.attr("width", svgWidth)
					.attr("height", svgHeight);

				/* 
				 *	ADD Y SCALE
				 */
	    		var yScale = d3.scale.linear()
	    			.domain([-1, d3.max(dataset, function(d) {
	    				return d.meanTemp;
	    			})])
	    			.range([diagramHeight, -1]);	

				/* 
				 *	DRAW BARS
				 */
				svgContainer.selectAll("rect")
					.data(dataset)
					.enter()
					.append("rect")
					.attr("x", function(d, i) {
						// divide bars over total width of svgContainer
						return i * 
							(diagramWidth / dataset.length) + 
							yAxisWidth + 
							axisPadding;
					})
					.attr("y", function(d) {
						// = height - data value (bars get drawn from top-left corner)
						return yScale(d.meanTemp) * heightFactor;
					})
					.attr("width", diagramWidth / dataset.length - barPadding)
					.attr("height", function(d) {
						// return height of bar, rightly scaled
						return (diagramHeight - yScale(d.meanTemp)) * heightFactor;
					});

				/* 
				 *	ADD VALUE TO BARS
				 */
				svgContainer.selectAll("text")
					.data(dataset)
					.enter()
					.append("text")
					.text(function(d) {
						return d;
					})
					.attr("x", function(d, i) {
						// center label horizontally inside bar
						return i * 
							(diagramWidth / dataset.length) + 
							(diagramWidth / dataset.length) / 2 +
							yAxisWidth + 
							axisPadding - 
							(barPadding / 2);
					})
					.attr("y", function(d) {
						// = height - data value
						return yScale(d) * heightFactor + 15;
					})
					.attr("font-family", "sans-serif")
				    .attr("font-size", "11px")
				    .attr("fill", "white")
				    .attr("text-anchor", "middle");

				/* 
				 *	ADD LABELS UNDERNEATH BARS
				 */
				svgContainer.selectAll("label")
					.data(months)
					.enter()
					.append("text")
					.text(function(d) {
						return d;
					})
					.attr("x", function(d, i) {
						// center label horizontally inside bar
						return i * 
							(diagramWidth / dataset.length) + 
							(diagramWidth / dataset.length) / 2 +
							yAxisWidth + 
							axisPadding - 
							(barPadding / 2);
					})
					.attr("y", function(d) {
						return diagramHeight + xAxisHeight - 5;
					})
					.attr("font-family", "sans-serif")
				    .attr("font-size", "11px")
				    .attr("text-anchor", "middle");

			    /* 
				 *	ADD YEAR LABEL TO DIAGRAM
				 */
				svgContainer.selectAll("year")
					.data(dataset)
					.enter()
					.append("text")
					.text(function(d) {
						return d.year
					})
					.attr("x", 50)
					.attr("y", 40)
					.attr("font-family", "sans-serif")
					.attr("font-size", "20px")
					.attr("font-weight", "bold");

			    /* 
				 *	CREATE Y AXIS
				 */

			    // create y axis
				var yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.ticks(5);

				// call y axis
				svgContainer.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(" + yAxisWidth + ",0)")
					.call(yAxis);
		 	}

			

		</script>
	</body>
</html>

<style type="text/css">
	div.bar {
		display: inline-block;
		width: 20px;
		height: 75px;
		margin-right: 2px;
		background-color: teal;
	}

	.axis path,
	.axis line {
		fill: none;
		stroke: black;
		shape-rendering: crispEdges;
	}

	.axis text {
	    font-family: sans-serif;
	    font-size: 11px;
	}	

</style>
